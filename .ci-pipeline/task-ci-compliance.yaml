---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: ci-compliance
spec:
  params:
    - name: compliance-baseimage
      description: base image to run most of the built-in pipeline code
    - name: pipeline-debug
      description: Pipeline debug mode
      default: "0"
    - name: next-stage
      default: ""

    - name: detect-secrets-image
      default: "wcp-compliance-automation-team-docker-local.artifactory.swg-devops.com/detect-secrets:0.13.1.ibm.31.dss@sha256:972a827e988f6443f478b7443dc0c8d8761ec15127588103817bb168667ebd0c"
    - name: cra-discovery-image
      default: "icr.io/continuous-delivery/cra-discovery:release.1571@sha256:d8474a311102a80de43bef3022787e9e61d0310dd2488898ea22152aeace9531"
    - name: cra-vulnerability-image
      default: "icr.io/continuous-delivery/cra-vulnerability:main.1266@sha256:1fe23cb8b5bd694433ebdaa7eb890008567041caa67ff2182b32dfda9661203c"
    - name: cra-cis-check-image
      default: "icr.io/continuous-delivery/cra-cis:release.1567@sha256:e97cedf14eab2dff46cc961c4aad2a5f49f724a384238becd537516217cc79b6"
    - name: cra-comm-editor-image
      default: "icr.io/continuous-delivery/cra-comm-editor:main.1260@sha256:e6c76eef0e5d1900f341250b79a7da411a46a99d845f01a4c1ceef5a9598f766"
    - name: cra-bom-check-image
      default: "icr.io/continuous-delivery/cra-bom:release.1484@sha256:c9a49aaaf4a020b5efa66dcd0a093fde2917c2692cdbc0b32088abdd5195cfe9"

  results:
    - name: image
      description: Docker image to be used in the specified stage.
    - name: script
      description: Location of the script that's going to be used to run the specified stage.
    - name: configmap
      description: "Name of the `ConfigMap` that's going to be mounted in `run-stage`"
    - name: secret
      description: "Name of the `Secret` that's going to be mounted in `run-stage`"
    - name: working-dir
      description: "one-pipeline working dir, the location of one-pipeline.yaml"
    - name: abort-on-failure
      description: "Whether abort the pipeline in case of a failure or not"
    - name: dind
      description: Launch Docker-in-Docker sidecar
    - name: image-pull-policy
      description: Set the imagePullPolicy for the Docker image in the runner task

  workspaces:
    - name: artifacts
      mountPath: /artifacts

  volumes:
    - name: one-pipeline
      emptyDir: {}
    - name: pipelinectl
      emptyDir: {}
    - name: config
      emptyDir: {}
    - name: dind-certs
      emptyDir: {}
    - name: environment-properties
      configMap:
        name: environment-properties
    - name: secure-properties
      secret:
        secretName: secure-properties
    - name: toolchain
      configMap:
        name: toolchain

  stepTemplate:
    env:
      - name: ONE_PIPELINE_PATH
        value: "/opt/one-pipeline"
      - name: WORKSPACE
        value: "$(workspaces.artifacts.path)"
      - name: TRIGGER_PAYLOAD
        valueFrom:
          configMapKeyRef:
            name: trigger
            key: payload.json
      - name: PIPELINE_RUN_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.labels['tekton.dev/pipelineRun']
      - name: PIPELINE_RUN_ID
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['devops.cloud.ibm.com/tekton-pipeline']
      - name: PIPELINE_RUN_URL
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['devops.cloud.ibm.com/pipeline-run-url']
      - name: BUILD_NUMBER
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['devops.cloud.ibm.com/build-number']
      - name: PIPELINE_ID
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['devops.cloud.ibm.com/pipeline-id']
      - name: TRIGGER_TYPE
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['devops.cloud.ibm.com/trigger-type']
      - name: TRIGGER_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['devops.cloud.ibm.com/trigger-name']
      - name: TRIGGERED_BY
        valueFrom:
          fieldRef:
            fieldPath: metadata.annotations['devops.cloud.ibm.com/triggered-by']
      - name: PIPELINE_DEBUG
        value: $(params.pipeline-debug)
      - name: DOCKER_HOST
        value: tcp://localhost:2376
      - name: DOCKER_TLS_VERIFY
        value: '1'
      - name: DOCKER_CERT_PATH
        value: /certs/client

  sidecars:
    - name: dind
      image: docker.io/library/docker:19-dind
      securityContext:
        privileged: true
      env:
        - name: DOCKER_TLS_CERTDIR
          value: /certs
        - name: ENABLE_DIND
          value: "true"
      volumeMounts:
        - name: dind-certs
          mountPath: /certs/client
      script: |
        if [[ "$ENABLE_DIND" == "true" ]]; then
          if [[ $(df -PT /var/lib/docker | awk 'NR==2 {print $2}') == virtiofs ]]; then
            apk add e2fsprogs
            truncate -s 20G /tmp/disk.img
            mkfs.ext4 /tmp/disk.img
            mount /tmp/disk.img /var/lib/docker
          fi
          # Set the MTU to a value that is containable in the ibmcloud calico mtu value
          # References:
          # - https://liejuntao001.medium.com/fix-docker-in-docker-network-issue-in-kubernetes-cc18c229d9e5
          # - https://cloud.ibm.com/docs/containers?topic=containers-kernel#calico-mtu
          #
          /usr/local/bin/dockerd-entrypoint.sh --mtu=1400
        else
          mkdir -p /certs/client
          touch /certs/client/ca.pem
        fi
      readinessProbe:
        periodSeconds: 1
        exec:
          command: ['ls', '/certs/client/ca.pem']

  steps:

    - name: prepare
      image: $(params.compliance-baseimage)
      workingDir: $(workspaces.artifacts.path)
      volumeMounts:
        - name: one-pipeline
          mountPath: /usr/share/one-pipeline
        - name: pipelinectl
          mountPath: /usr/share/cocoa
        - name: config
          mountPath: /config
        - name: environment-properties
          mountPath: /config/environment-properties
        - name: secure-properties
          mountPath: /config/secure-properties
        - name: toolchain
          mountPath: /toolchain

      script: |
        #!/bin/bash

        set -e

        if [[ "$PIPELINE_DEBUG" == 1 ]]; then
          set -x
          trap env EXIT
        fi

        while read file; do
          ln -snf "$file" "/config/$(basename "$file")"
        done < <(find '/config/environment-properties' -type f)

        while read file; do
          ln -snf "$file" "/config/$(basename "$file")"
        done < <(find '/config/secure-properties' -type f)

        cp -r /opt/one-pipeline /usr/share
        cp -r /opt/cocoa/bin /usr/share/cocoa

        mkdir -p "${WORKSPACE}/__cra__"
        chmod 777 "${WORKSPACE}/__cra__"

        chmod 777 /usr/share/cocoa/bin

    - name: detect-secrets
      image: $(params.detect-secrets-image)
      workingDir: $(workspaces.artifacts.path)
      volumeMounts:
        - name: one-pipeline
          mountPath: /opt/one-pipeline
        - name: pipelinectl
          mountPath: /opt/cocoa
        - name: config
          mountPath: /config
        - name: environment-properties
          mountPath: /config/environment-properties
        - name: secure-properties
          mountPath: /config/secure-properties
        - name: toolchain
          mountPath: /toolchain

      script: |
        #!/bin/sh

        export PATH="$PATH:/opt/cocoa/bin"

        ${ONE_PIPELINE_PATH}/internal/detect-secrets/run

    - name: cra-discovery
      image: $(params.cra-discovery-image)
      workingDir: $(workspaces.artifacts.path)
      volumeMounts:
        - name: one-pipeline
          mountPath: /opt/one-pipeline
        - name: pipelinectl
          mountPath: /opt/cocoa
        - name: config
          mountPath: /config
        - name: environment-properties
          mountPath: /config/environment-properties
        - name: secure-properties
          mountPath: /config/secure-properties
        - name: toolchain
          mountPath: /toolchain
        - name: dind-certs
          mountPath: /certs/client
      script: |
        #!/bin/bash

        export PATH="$PATH:/opt/cocoa/bin"

        . ${ONE_PIPELINE_PATH}/internal/cra/discovery

    - name: cra-remediation
      image: $(params.cra-vulnerability-image)
      workingDir: $(workspaces.artifacts.path)
      volumeMounts:
        - name: one-pipeline
          mountPath: /opt/one-pipeline
        - name: pipelinectl
          mountPath: /opt/cocoa
        - name: config
          mountPath: /config
        - name: environment-properties
          mountPath: /config/environment-properties
        - name: secure-properties
          mountPath: /config/secure-properties
        - name: toolchain
          mountPath: /toolchain
        - name: dind-certs
          mountPath: /certs/client
      script: |
        #!/bin/bash

        export PATH="$PATH:/opt/cocoa/bin"

        . "${ONE_PIPELINE_PATH}"/internal/cra/remediation

    - name: cra-cis-check
      image: $(params.cra-cis-check-image)
      workingDir: $(workspaces.artifacts.path)
      volumeMounts:
        - name: one-pipeline
          mountPath: /opt/one-pipeline
        - name: pipelinectl
          mountPath: /opt/cocoa
        - name: config
          mountPath: /config
        - name: environment-properties
          mountPath: /config/environment-properties
        - name: secure-properties
          mountPath: /config/secure-properties
        - name: toolchain
          mountPath: /toolchain
        - name: dind-certs
          mountPath: /certs/client
      script: |
        #!/bin/bash

        export PATH="$PATH:/opt/cocoa/bin"

        pipeline_data="${WORKSPACE}/pipeline.data"
        source "$pipeline_data"

        . "${ONE_PIPELINE_PATH}"/internal/cra/cis-check

    - name: cra-bom-check
      image: $(params.cra-bom-check-image)
      workingDir: $(workspaces.artifacts.path)
      volumeMounts:
        - name: one-pipeline
          mountPath: /opt/one-pipeline
        - name: pipelinectl
          mountPath: /opt/cocoa
        - name: config
          mountPath: /config
        - name: environment-properties
          mountPath: /config/environment-properties
        - name: secure-properties
          mountPath: /config/secure-properties
        - name: toolchain
          mountPath: /toolchain
        - name: dind-certs
          mountPath: /certs/client
      script: |
        #!/bin/bash

        export PATH="$PATH:/opt/cocoa/bin"

        . "${ONE_PIPELINE_PATH}"/internal/cra/bom-check

    - name: finish
      image: $(params.compliance-baseimage)
      workingDir: $(workspaces.artifacts.path)
      volumeMounts:
        - name: config
          mountPath: /config
        - name: environment-properties
          mountPath: /config/environment-properties
        - name: secure-properties
          mountPath: /config/secure-properties
        - name: toolchain
          mountPath: /toolchain
      script: |
        #!/bin/bash

        export PATH="$PATH:/opt/cocoa/bin"

        . "${ONE_PIPELINE_PATH}"/internal/ci_compliance_checks

    - name: prepare-next-stage
      image: $(params.compliance-baseimage)
      volumeMounts:
        - name: environment-properties
          mountPath: /config
      env:
        - name: STAGE
          value: "$(params.next-stage)"
      script: |
        #!/bin/bash

        if [ -z "$STAGE" ]; then
          exit 0
        fi

        . "${ONE_PIPELINE_PATH}"/internal/stage/parse_config

        echo -n "${STAGE_IMAGE}" > "$(results.image.path)"
        echo -n "${STAGE_SCRIPT_PATH}" > "$(results.script.path)"
        echo -n "${STAGE_DIND}" > "$(results.dind.path)"
        echo -n "${STAGE_ABORT_ON_FAILURE}" > "$(results.abort-on-failure.path)"
        echo -n "${STAGE_IMAGE_PULL_POLICY}" > "$(results.image-pull-policy.path)"
        echo -n "${STAGE_CONFIGMAP}" > "$(results.configmap.path)"
        echo -n "${STAGE_SECRET}" > "$(results.secret.path)"
