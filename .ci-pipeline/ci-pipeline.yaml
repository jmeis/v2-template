---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: pipeline
spec:
  params:
    - name: registry-namespace
      description: The namespace in the container image registry. You can set it up
        with {bx cr namespace-add]. Learn more at
        https://cloud.ibm.com/docs/services/Registry?topic=registry-getting-started#getting-started.
    - name: app-name
      description: The name of your app
    - name: registry-region
      description: The IBM Cloud region for image registry
    - name: branch
      description: the branch for the git repo
      default: "master"
    - name: cluster-name
      description: the name of the cluster to target
    - name: dev-cluster-namespace
      description: the namespace
    - name: repository-integration
      description: the repo integration name
    - name: dev-resource-group
      description: Resource Group
    - name: dev-region
      description: target region
    - name: pipeline-debug
      description: toggles debug mode for the pipeline
    - name: commit-id
      description: commit id
    - name: pr-url
      description: pr url
      default: ""
    - name: inventory-repo
      description: inventory repository owner and name
    - name: version
      description: cr branch name
    - name: slack-notifications
      description: toggles slack notifications
    - name: cos-bucket-name
      description: Bucket name in your Cloud Object Storage instance, used as an Evidence Locker
      default: ""
    - name: cos-endpoint
      description: Endpoint of your Cloud Object Storage instance, used as an Evidence Locker
      default: ""
    - name: one-pipeline-config
      description: Configuration file to be used to customize pipeline behavior
      default: .one-pipeline.yaml
    - name: doi-toolchain-id
      description: DevOps Toolchain ID
      default: ""

  workspaces:
    - name: artifacts

  tasks:
    - name: code-notify-pipeline-start
      taskRef:
        name: slack-post-message
      workspaces:
        - name: workspace
          workspace: artifacts
      params:
        - name: message-script
          value: |
              #!/usr/bin/env python3
              import os

              print("CI Pipeline was Triggered By: " + os.getenv("TRIGGERED_BY"))
              print("<https://cloud.ibm.com/devops/pipelines/tekton/" + os.getenv("PIPELINE_ID") + "/runs/" + os.getenv("PIPELINE_RUN_ID") + "?env_id=ibm:yp:" + os.getenv("TOOLCHAIN_REGION") + "|See the Pipeline Logs>")

    - name: code-extract-toolchain-crn
      taskRef:
        name: toolchain-extract-value
      params:
        - name: expression
          value: ".crn"
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: code-extract-repository-url
      taskRef:
        name: toolchain-extract-value
      params:
        - name: expression
          value: '.services[] | select(.toolchain_binding.name=="app-repo") | .dashboard_url'
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: code-extract-evidence-repo-url
      taskRef:
        name: toolchain-extract-value
      params:
        - name: expression
          value: '.services[] | select(.toolchain_binding.name=="evidence-repo") | .dashboard_url'
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: code-extract-issues-repo-url
      taskRef:
        name: toolchain-extract-value
      params:
        - name: expression
          value: '.services[] | select(.toolchain_binding.name=="issues-repo") | .dashboard_url'
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: code-fetch-credentials
      runAfter:
        - code-extract-toolchain-crn
        - code-extract-evidence-repo-url
        - code-extract-issues-repo-url
      taskRef:
        name: git-get-credentials
      workspaces:
        - name: artifacts
          workspace: artifacts
        - name: secrets
          workspace: artifacts
      params:
        - name: ibmcloud-api-key-secret-key
          value: api-key
        - name: repository
          value: $(tasks.code-extract-repository-url.results.extracted-value)
        - name: repository-integration
          value: $(params.repository-integration)
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: code-fetch-code
      runAfter:
        - code-fetch-credentials
      taskRef:
        name: git-clone
      workspaces:
        - name: artifacts
          workspace: artifacts
        - name: secrets
          workspace: artifacts
      params:
        - name: repository
          value: $(tasks.code-extract-repository-url.results.extracted-value)
        - name: git-user
          value: $(tasks.code-fetch-credentials.results.git-auth-user)
        - name: branch
          value: $(params.branch)
        - name: revision
          value: $(params.commit-id)
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: code-detect-secrets
      runAfter:
        - code-fetch-code
      taskRef:
        name: compliance-detect-secrets
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: app-directory
          value: $(tasks.code-fetch-code.results.directory-name)

    - name: build-doi-publish-buildrecord
      taskRef:
        name: doi-publish-buildrecord
      params:
        - name: app-name
          value: "$(params.app-name)"
        - name: toolchain-apikey-secret-key
          value: "api-key"
        - name: git-repository
          value: $(tasks.code-extract-repository-url.results.extracted-value)
        - name: git-branch
          value: $(params.branch)
        - name: git-commit
          value: $(tasks.code-fetch-code.results.git-commit)
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: toolchain-id
          value: $(params.doi-toolchain-id)

    - name: code-setup-config
      runAfter:
        - code-fetch-code
      taskRef:
        name: parse-config
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: file
          value: $(tasks.code-fetch-code.results.directory-name)/$(params.one-pipeline-config)
        - name: stage
          value: setup

    - name: code-setup
      taskRef:
        name: run-stage
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: image
          value: $(tasks.code-setup-config.results.image)
        - name: script
          value: $(tasks.code-setup-config.results.script)
        - name: working-dir
          value: $(tasks.code-fetch-code.results.directory-name)
        - name: configmap-0
          value: $(tasks.code-setup-config.results.configmap-0)
        - name: configmap-1
          value: $(tasks.code-setup-config.results.configmap-1)
        - name: configmap-2
          value: $(tasks.code-setup-config.results.configmap-2)
        - name: configmap-3
          value: $(tasks.code-setup-config.results.configmap-3)
        - name: configmap-4
          value: $(tasks.code-setup-config.results.configmap-4)
        - name: secret-0
          value: $(tasks.code-setup-config.results.secret-0)
        - name: secret-1
          value: $(tasks.code-setup-config.results.secret-1)
        - name: secret-2
          value: $(tasks.code-setup-config.results.secret-2)
        - name: secret-3
          value: $(tasks.code-setup-config.results.secret-3)
        - name: secret-4
          value: $(tasks.code-setup-config.results.secret-4)

    - name: code-unit-tests-config
      runAfter:
        - code-setup
      taskRef:
        name: parse-config
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: file
          value: $(tasks.code-fetch-code.results.directory-name)/$(params.one-pipeline-config)
        - name: stage
          value: test

    - name: code-unit-tests
      taskRef:
        name: run-stage
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: image
          value: $(tasks.code-unit-tests-config.results.image)
        - name: script
          value: $(tasks.code-unit-tests-config.results.script)
        - name: working-dir
          value: $(tasks.code-fetch-code.results.directory-name)
        - name: configmap-0
          value: $(tasks.code-unit-tests-config.results.configmap-0)
        - name: configmap-1
          value: $(tasks.code-unit-tests-config.results.configmap-1)
        - name: configmap-2
          value: $(tasks.code-unit-tests-config.results.configmap-2)
        - name: configmap-3
          value: $(tasks.code-unit-tests-config.results.configmap-3)
        - name: configmap-4
          value: $(tasks.code-unit-tests-config.results.configmap-4)
        - name: secret-0
          value: $(tasks.code-unit-tests-config.results.secret-0)
        - name: secret-1
          value: $(tasks.code-unit-tests-config.results.secret-1)
        - name: secret-2
          value: $(tasks.code-unit-tests-config.results.secret-2)
        - name: secret-3
          value: $(tasks.code-unit-tests-config.results.secret-3)
        - name: secret-4
          value: $(tasks.code-unit-tests-config.results.secret-4)

    - name: code-vulnerability-scan-uploader
      runAfter:
        - code-unit-tests
      taskRef:
        name: gitsecure-discovery
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: repository
          value: $(tasks.code-extract-repository-url.results.extracted-value)
        - name: revision
          value: $(params.branch)
        - name: commit-id
          value: $(tasks.code-fetch-code.results.git-commit)
        - name: directory-name
          value: $(tasks.code-fetch-code.results.directory-name)

    - name: code-vulnerability-scan
      runAfter:
        - code-vulnerability-scan-uploader
      taskRef:
        name: gitsecure-vulnerability-remediation
      workspaces:
        - name: artifacts
          workspace: artifacts
        - name: secrets
          workspace: artifacts
      params:
        - name: repository
          value: $(tasks.code-extract-repository-url.results.extracted-value)
        - name: revision
          value: $(params.branch)
        - name: pr-url
          value: $(params.pr-url)
        - name: commit-id
          value: $(tasks.code-fetch-code.results.git-commit)
        - name: git-api-token-key
          value: git-token

    - name: code-cis-check
      taskRef:
        name: gitsecure-cis-check
      runAfter:
        - code-vulnerability-scan-uploader
      workspaces:
        - name: secrets
          workspace: artifacts
        - name: artifacts
          workspace: artifacts
      params:
        - name: repository
          value: $(tasks.code-extract-repository-url.results.extracted-value)
        - name: revision
          value: $(params.branch)
        - name: pr-url
          value: $(params.pr-url)
        - name: commit-id
          value: $(tasks.code-fetch-code.results.git-commit)
        - name: directory-name
          value: $(tasks.code-fetch-code.results.directory-name)

    - name: code-bom-check
      runAfter:
        - code-vulnerability-scan-uploader
      taskRef:
        name: gitsecure-bom-check
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: repository
          value: $(tasks.code-extract-repository-url.results.extracted-value)
        - name: revision
          value: $(params.branch)
        - name: commit-id
          value: $(tasks.code-fetch-code.results.git-commit)

    - name: get-org
      runAfter:
        - code-fetch-credentials
      params:
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: repository
          value: $(tasks.code-extract-repository-url.results.extracted-value)
      taskSpec:
        params:
          - name: pipeline-debug
            default: "0"
          - name: repository
        results:
          - name: gh-org
        stepTemplate:
          env:
            - name: PIPELINE_DEBUG
              value: $(params.pipeline-debug)
        steps:
          - name: get-params
            image: ibmcom/pipeline-base-image:2.6
            script: |
              #!/bin/bash

              set -e -o pipefail

              if [ $PIPELINE_DEBUG == 1 ]; then
                pwd
                env
                trap env EXIT
                set -x
              fi

              OWNER=$(echo "$(params.repository)" | cut -d/ -f4 )
              echo -n $OWNER | tee $(results.gh-org.path)

    - name: code-branch-protection
      taskRef:
        name: github-check-statuses
      runAfter:
        - code-fetch-code
      workspaces:
        - name: secrets
          workspace: artifacts
      params:
        - name: target-branch
          value: $(params.branch)
        - name: required-checks
          value: |
            [{
              "type": "branch-protection",
              "name": "code-review",
              "params": {
                "checks": [
                  "tekton/code-branch-protection",
                  "tekton/code-unit-tests",
                  "tekton/code-cis-check",
                  "tekton/code-vulnerability-scan",
                  "tekton/code-detect-secrets"
                ]
              }
            }]
        - name: gh-org
          value: $(tasks.get-org.results.gh-org)
        - name: repository
          value: $(tasks.code-fetch-credentials.results.repo-name)
        - name: git-commit
          value: $(tasks.code-fetch-code.results.git-commit)
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: code-check-dockerfile
      runAfter:
        - code-fetch-code
      taskRef:
        name: icr-check-dockerfile
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: app-directory
          value: $(tasks.code-fetch-code.results.directory-name)
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: build-containerize
      taskRef:
        name: icr-containerize
      runAfter:
        - code-check-dockerfile
      workspaces:
        - name: source
          workspace: artifacts
      params:
        - name: registry-region
          value: $(params.registry-region)
        - name: registry-namespace
          value: $(params.registry-namespace)
        - name: image-name
          value: $(params.app-name)
        - name: additional-tags-script
          value: |
            # The script is providing tag(s) as output
            # But logs can be written as error stderr
            echo "Providing an image tag including git branch and commit" >&2
            # Add a specific tag with branch and commit
            echo "$(date +%Y%m%d%H%M%S)-$(tasks.code-fetch-code.results.git-branch)-$(tasks.code-fetch-code.results.git-commit)"
        - name: container-registry-apikey-secret-key
          value: api-key
        - name: path-to-context
          value: "$(tasks.code-fetch-code.results.directory-name)"
        - name: path-to-dockerfile
          value: "./$(tasks.code-fetch-code.results.directory-name)"
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: build-update-inventory
      taskRef:
        name: inventory-update-version
      runAfter:
        - build-containerize
      workspaces:
        - name: artifacts
          workspace: artifacts
        - name: secrets
          workspace: artifacts
      params:
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: inventory-repo
          value: $(params.inventory-repo)
        - name: version
          value: $(params.version)
        - name: artifact
          value: "$(tasks.build-containerize.results.image-repository)@$(tasks.build-containerize.results.image-digest)"
        - name: app-name
          value: $(params.app-name)
        - name: repository-url
          value: $(tasks.code-extract-repository-url.results.extracted-value)
        - name: commit-sha
          value: $(tasks.code-fetch-code.results.git-commit)

    - name: build-vulnerability-advisor
      taskRef:
        name: icr-check-va-scan
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: image-url
          value: $(tasks.build-containerize.results.image-repository)
        - name: image-digest
          value: $(tasks.build-containerize.results.image-digest)
        - name: scan-report-file
          value: 'app-image-va-report.json'
        - name: ibmcloud-api-key-secret-key
          value: "api-key"
        - name: fail-on-scanned-issues
          value: "false"
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: build-image-signing
      runAfter:
        - build-vulnerability-advisor
      taskRef:
        name: ciso-sign
      params:
        - name: region
          value: $(params.dev-region)
        - name: resource-group
          value: $(params.dev-resource-group)
        - name: registry-region
          value: $(params.registry-region)
        - name: registry-namespace
          value: $(params.registry-namespace)
        - name: image-name
          value: $(params.app-name)
        - name: image-tag
          value: $(tasks.build-containerize.results.image-tags)
      workspaces:
        - name: artifacts
          workspace: artifacts

    - name: deploy-dev-config
      runAfter:
        - build-image-signing
      taskRef:
        name: parse-config
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: file
          value: $(tasks.code-fetch-code.results.directory-name)/$(params.one-pipeline-config)
        - name: stage
          value: deploy

    - name: deploy-dev
      taskRef:
        name: run-stage
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: image
          value: $(tasks.deploy-dev-config.results.image)
        - name: script
          value: $(tasks.deploy-dev-config.results.script)
        - name: working-dir
          value: $(tasks.code-fetch-code.results.directory-name)
        - name: params
          value: |
            image: $(tasks.build-containerize.results.image-repository)@$(tasks.build-containerize.results.image-digest)
        - name: configmap-0
          value: $(tasks.deploy-dev-config.results.configmap-0)
        - name: configmap-1
          value: $(tasks.deploy-dev-config.results.configmap-1)
        - name: configmap-2
          value: $(tasks.deploy-dev-config.results.configmap-2)
        - name: configmap-3
          value: $(tasks.deploy-dev-config.results.configmap-3)
        - name: configmap-4
          value: $(tasks.deploy-dev-config.results.configmap-4)
        - name: secret-0
          value: $(tasks.deploy-dev-config.results.secret-0)
        - name: secret-1
          value: $(tasks.deploy-dev-config.results.secret-1)
        - name: secret-2
          value: $(tasks.deploy-dev-config.results.secret-2)
        - name: secret-3
          value: $(tasks.deploy-dev-config.results.secret-3)
        - name: secret-4
          value: $(tasks.deploy-dev-config.results.secret-4)

    - name: deploy-acceptance-tests-config
      runAfter:
        - deploy-dev
      taskRef:
        name: parse-config
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: file
          value: $(tasks.code-fetch-code.results.directory-name)/$(params.one-pipeline-config)
        - name: stage
          value: acceptance-test

    - name: deploy-acceptance-tests
      taskRef:
        name: run-stage
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: image
          value: $(tasks.deploy-acceptance-tests-config.results.image)
        - name: script
          value: $(tasks.deploy-acceptance-tests-config.results.script)
        - name: working-dir
          value: $(tasks.code-fetch-code.results.directory-name)
        - name: configmap-0
          value: $(tasks.deploy-acceptance-tests-config.results.configmap-0)
        - name: configmap-1
          value: $(tasks.deploy-acceptance-tests-config.results.configmap-1)
        - name: configmap-2
          value: $(tasks.deploy-acceptance-tests-config.results.configmap-2)
        - name: configmap-3
          value: $(tasks.deploy-acceptance-tests-config.results.configmap-3)
        - name: configmap-4
          value: $(tasks.deploy-acceptance-tests-config.results.configmap-4)
        - name: secret-0
          value: $(tasks.deploy-acceptance-tests-config.results.secret-0)
        - name: secret-1
          value: $(tasks.deploy-acceptance-tests-config.results.secret-1)
        - name: secret-2
          value: $(tasks.deploy-acceptance-tests-config.results.secret-2)
        - name: secret-3
          value: $(tasks.deploy-acceptance-tests-config.results.secret-3)
        - name: secret-4
          value: $(tasks.deploy-acceptance-tests-config.results.secret-4)

    - name: dev-publish-deployrecord
      taskRef:
        name: doi-publish-deployrecord
      runAfter:
        - deploy-dev
      params:
        - name: app-name
          value: "$(params.app-name)"
        - name: toolchain-id
          value: "$(params.doi-toolchain-id)"
        - name: environment
          value: "dev"
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: toolchain-apikey-secret-key
          value: "api-key"

    - name: build-compliance-collector
      taskRef:
        name: compliance-collector
      workspaces:
        - name: artifacts
          workspace: artifacts
        - name: secrets
          workspace: artifacts
      params:
        - name: namespace
          value: ci
        - name: incident-issue-repo
          value: $(tasks.code-extract-issues-repo-url.results.extracted-value)
        - name: evidence-repo-url
          value: $(tasks.code-extract-evidence-repo-url.results.extracted-value)
        - name: commit-hash
          value: $(tasks.code-fetch-code.results.git-commit)
        - name: toolchain-crn
          value: $(tasks.code-extract-toolchain-crn.results.extracted-value)
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: toolchain-apikey-secret-key
          value: "api-key"
        - name: cos-bucket-name
          value: "$(params.cos-bucket-name)"
        - name: cos-endpoint
          value: "$(params.cos-endpoint)"
        - name: data
          value: |
            [
              {
                "name": "code-detect-secrets",
                "step": "detect-secrets",
                "evidence_type": "com.ibm.detect_secrets",
                "evidence_type_version": "1.0.0",
                "expected": "success",
                "actual": "$(tasks.code-detect-secrets.results.status)",
                "artifacts": [
                ]
              },
              {
                "name": "code-unit-tests",
                "step": "run-script",
                "evidence_type": "com.ibm.unit_test",
                "evidence_type_version": "1.0.0",
                "expected": "success",
                "actual": "$(tasks.code-unit-tests.results.status)",
                "artifacts": [
                ]
              },
              {
                "name": "code-vulnerability-scan",
                "step": "remediation",
                "evidence_type": "com.ibm.code_vulnerability_scan",
                "evidence_type_version": "1.0.0",
                "expected": "success",
                "actual": "$(tasks.code-vulnerability-scan.results.status)",
                "artifacts": [
                  "$(tasks.code-vulnerability-scan.results.evidence-store)"
                ]
              },
              {
                "name": "code-cis-check",
                "step": "cis",
                "evidence_type": "com.ibm.code_cis_check",
                "evidence_type_version": "1.0.0",
                "expected": "success",
                "actual": "$(tasks.code-cis-check.results.status)",
                "artifacts": [
                  "$(tasks.code-cis-check.results.evidence-store)"
                ]
              },
              {
                "name": "code-bom-check",
                "step": "bom",
                "evidence_type": "com.ibm.code_bom_check",
                "evidence_type_version": "1.0.0",
                "expected": "success",
                "actual": "$(tasks.code-bom-check.results.status)",
                "artifacts": [
                  "$(tasks.code-bom-check.results.evidence-store)"
                ]
              },
              {
                "name": "code-branch-protection",
                "step": "check-github-statuses",
                "evidence_type": "com.ibm.branch_protection",
                "evidence_type_version": "1.0.0",
                "expected": "success",
                "actual": "$(tasks.code-branch-protection.results.status)",
                "artifacts": [
                ]
              },
              {
                "name": "build-vulnerability-advisor",
                "step": "run-vulnerability-advisor-scan",
                "evidence_type": "com.ibm.cloud.icr_check_va_scan",
                "evidence_type_version": "1.0.0",
                "expected": "OK",
                "actual": "$(tasks.build-vulnerability-advisor.results.scan-status)",
                "artifacts": [
                  "$(tasks.build-vulnerability-advisor.results.scan-report-file)"
                ]
              },
              {
                "name": "build-image-signing",
                "step": "sign-image",
                "evidence_type": "com.ibm.cloud.icr_ciso_image_signing",
                "evidence_type_version": "1.0.0",
                "expected": "success",
                "actual": "$(tasks.build-image-signing.results.status)",
                "artifacts": [
                  "$(tasks.build-image-signing.results.signature)"
                ]
              },
              {
                "name": "deploy-acceptance-tests",
                "step": "run-script",
                "evidence_type": "com.ibm.acceptance_test",
                "evidence_type_version": "1.0.0",
                "expected": "success",
                "actual": "$(tasks.deploy-acceptance-tests.results.status)",
                "artifacts": [
                ]
              }
            ]

    - name: build-compliance-doi-reporter
      taskRef:
        name: compliance-doi-reporter
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: app-name
          value: "$(params.app-name)"
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: ibmcloud-api-key-secret-key
          value: "api-key"
        - name: toolchain-id
          value: "$(params.doi-toolchain-id)"
        - name: data
          value: |
            [
              {
                "name": "code-detect-secrets",
                "step": "detect-secrets",
                "evidence_type": "com.ibm.detect_secrets",
                "expected": "success",
                "actual": "$(tasks.code-detect-secrets.results.status)"
              },
              {
                "name": "code-unit-tests",
                "step": "run-script",
                "evidence_type": "com.ibm.unit_test",
                "expected": "success",
                "actual": "$(tasks.code-unit-tests.results.status)"
              },
              {
                "name": "code-vulnerability-scan",
                "step": "remediation",
                "evidence_type": "com.ibm.code_vulnerability_scan",
                "expected": "success",
                "actual": "$(tasks.code-vulnerability-scan.results.status)"
              },
              {
                "name": "code-cis-check",
                "step": "cis",
                "evidence_type": "com.ibm.code_cis_check",
                "expected": "success",
                "actual": "$(tasks.code-cis-check.results.status)"
              },
              {
                "name": "code-bom-check",
                "step": "bom",
                "evidence_type": "com.ibm.code_bom_check",
                "expected": "success",
                "actual": "$(tasks.code-bom-check.results.status)"
              },
              {
                "name": "code-branch-protection",
                "step": "check-github-statuses",
                "evidence_type": "com.ibm.branch_protection",
                "expected": "success",
                "actual": "$(tasks.code-branch-protection.results.status)"
              },
              {
                "name": "build-vulnerability-advisor",
                "step": "run-vulnerability-advisor-scan",
                "evidence_type": "com.ibm.cloud.icr_check_va_scan",
                "expected": "OK",
                "actual": "$(tasks.build-vulnerability-advisor.results.scan-status)"
              },
              {
                "name": "build-image-signing",
                "step": "sign-image",
                "evidence_type": "com.ibm.cloud.icr_ciso_image_signing",
                "expected": "success",
                "actual": "$(tasks.build-image-signing.results.status)"
              },
              {
                "name": "deploy-acceptance-tests",
                "step": "run-script",
                "evidence_type": "com.ibm.acceptance_test",
                "expected": "success",
                "actual": "$(tasks.deploy-acceptance-tests.results.status)"
              }
            ]

    - name: build-notify-pipeline-end
      runAfter:
        - build-compliance-collector
        - build-compliance-doi-reporter
      taskRef:
        name: slack-post-message
      workspaces:
        - name: workspace
          workspace: artifacts
      params:
        - name: message-script
          value: |
              #!/usr/bin/env python3
              import json, os

              results = json.loads("""
                [
                  {
                    "name": "code-unit-tests",
                    "expected": "success",
                    "actual": "$(tasks.code-unit-tests.results.status)"
                  },
                  {
                    "name": "deploy-acceptance-tests",
                    "expected": "success",
                    "actual": "$(tasks.deploy-acceptance-tests.results.status)"
                  },
                  {
                    "name": "code-vulnerability-scan",
                    "expected": "success",
                    "actual": "$(tasks.code-vulnerability-scan.results.status)"
                  },
                  {
                    "name": "code-cis-check",
                    "expected": "success",
                    "actual": "$(tasks.code-cis-check.results.status)"
                  },
                  {
                    "name": "code-bom-check",
                    "expected": "success",
                    "actual": "$(tasks.code-bom-check.results.status)"
                  },
                  {
                    "name": "code-branch-protection",
                    "expected": "success",
                    "actual": "$(tasks.code-branch-protection.results.status)"
                  },
                  {
                    "name": "build-vulnerability-advisor",
                    "expected": "OK",
                    "actual": "$(tasks.build-vulnerability-advisor.results.scan-status)"
                  },
                  {
                    "name": "code-detect-secrets",
                    "expected": "success",
                    "actual": "$(tasks.code-detect-secrets.results.status)"
                  },
                  {
                    "name": "build-image-signing",
                    "expected": "success",
                    "actual": "$(tasks.build-image-signing.results.status)"
                  }
                ]
              """)

              for result in results:
                if result["actual"] != result["expected"]:
                  print(":x: Task `{taskName}` has failed.".format(taskName=result["name"]))
                else:
                  print(":white_check_mark: Task `{taskName}` was successful.".format(taskName=result["name"]))
              print("CI Pipeline finished!")
              print("<https://cloud.ibm.com/devops/pipelines/tekton/" + os.getenv("PIPELINE_ID") + "/runs/" + os.getenv("PIPELINE_RUN_ID") + "?env_id=ibm:yp:" + os.getenv("TOOLCHAIN_REGION") + "|See the Pipeline Logs>")

    - name: build-pipeline-evaluator
      runAfter:
        - build-compliance-doi-reporter
        - build-compliance-collector
        - build-notify-pipeline-end
      taskRef:
        name: util-evaluate-pipeline-results
      params:
        - name: results
          value: |
            [
              {
                "name": "code-unit-tests",
                "expected": "success",
                "actual": "$(tasks.code-unit-tests.results.status)"
              },
              {
                "name": "deploy-acceptance-tests",
                "expected": "success",
                "actual": "$(tasks.deploy-acceptance-tests.results.status)"
              },
              {
                "name": "code-vulnerability-scan",
                "expected": "success",
                "actual": "$(tasks.code-vulnerability-scan.results.status)"
              },
              {
                "name": "code-cis-check",
                "expected": "success",
                "actual": "$(tasks.code-cis-check.results.status)"
              },
              {
                "name": "code-bom-check",
                "expected": "success",
                "actual": "$(tasks.code-bom-check.results.status)"
              },
              {
                "name": "code-branch-protection",
                "expected": "success",
                "actual": "$(tasks.code-branch-protection.results.status)"
              },
              {
                "name": "build-vulnerability-advisor",
                "expected": "OK",
                "actual": "$(tasks.build-vulnerability-advisor.results.scan-status)"
              },
              {
                "name": "code-detect-secrets",
                "expected": "success",
                "actual": "$(tasks.code-detect-secrets.results.status)"
              },
              {
                "name": "build-image-signing",
                "expected": "success",
                "actual": "$(tasks.build-image-signing.results.status)"
              }
            ]
