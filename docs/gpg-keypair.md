# Generating GPG KeyPair

1. Download and install the [GPG command line tools](https://www.gnupg.org/download/) for your operating system. Go to the `GnuPG binary releases` section to download the required tools for your operating system.
    - OS X - [Mac GPG](https://gpgtools.org/)
    - Windows - [Gpg4win](https://gpg4win.org/download.html)
    > **Note**: For Windows, download and install [GitBash](https://gitforwindows.org/). The tool is required to `base64` encode the key generated by GPG utility. Use GitBash prompt to run the commands to generate GPG Key as per below instruction.

2. Generate a GPG key pair. Provide appropriate values for `Real name` and `Email address`. Once finished select Option `O`

:warning::red_circle::warning:
**IMPORTANT**: Please leave the `passphrase` and `repeat` field empty if generate-key commands opens up dialog for the passphrase. This is a limitation with current [(skopeo)](https://github.com/containers/skopeo/issues/1261) utility of the image signing where the toolchain cannot accept a private key protected with passphrase. If you provide the passphrase, Toolchain may fail to decode the certificate, resulting in image sigining failure. 


   #### **`windows`**
   To the version of gpg installed - within command prompt, run
   ```
   $ gpg --version
    gpg (GnuPG) 2.2.27
    libgcrypt 1.8.7
    Copyright (C) 2021 g10 Code GmbH
   ```

   For GPG Version > 1.4, run 
   ```
   gpg --pinentry-mode loopback --passphrase=''   --generate-key 

   ```

   For GPG Versions < = 1.4 or any failure with above command, run
   ```
   gpg --gen-key 
   ```
   When prompted to select the kind of key, select Default option `(1) RSA and RSA (default)`.
   #### **`OS X/Linux`** 
   Within your shell prompt, run

   ```
   gpg --pinentry-mode loopback --passphrase=''   --generate-key 

   ```

3. Export the Private Key

    ```
    gpg --export-secret-key <Email Address>
    ```

:warning::red_circle::warning:
**Important**: The raw key exported here must not be copied directly. It is strongly recommended to securely store the key generated in this step in KeyProtect Instance or Secret Manager Instance. Please refer next sections for more details.

---
## Storing the Private Key in Key Protect Instance

You need to perform double `base64` encode of the Private Key before storing them in your Key Protect Instance. 
#### **`windows`**
```
gpg --export-secret-key <Email Address> | base64 -w0 | base64 -w0 | clip
```
#### **`Linux`** 
```
gpg --export-secret-key <Email Address> | base64 | base64
```
#### **`OS X`** 
```
gpg --export-secret-key <Email Address> | base64 | base64 | pbcopy
```
> Note: Please make sure that keys are copied in correct format to avoid siging failure due to import failure. It is advised to use `pbcopy` in the above command to copy the key contents to clipboard.` 

1. In your IBM Cloud Console, select the Key Protect Instance where you want to store GPG Key generated from the steps above.
2. Click on the `Add +` icon on the top right to add new key to the instance.
3. Select `Import your own key` option
4. Select `Select a key type` as **Standard Key**
5. Give appropriate name in the `Key name` field. The stored GPG Key can be retreived later by this name.
6. Copy the key as exported earlier in the `Key material` field.
    > **Note**: Please ensure that while copying the key and pasting it in `Key material` field, there is no extra line at the end of the key.
7. Select the `Choose a key ring` option as default. 
8. Add the key to your key protect by clicking `Add key` icon at the bottom.

| ![Save Key To Key Protect](./images/devsecops_set-up_store_key_protect.png) |
| :--: |

---

## Storing the Private Key in IBM Secrets Manager Instance 


You need to perfrom double `base64` encode of the Private Key before storing them in your Key Protect Instance. For example, on a linux based system you can perfrom the same as below:

#### **`windows`**
```
gpg --export-secret-key <Email Address> | base64 -w0 | clip
```
#### **`Linux`** 
```
gpg --export-secret-key <Email Address> | base64
```
#### **`OS X`** 
```
gpg --export-secret-key <Email Address> | base64 | pbcopy
```

1. In your IBM Cloud Console, select the Secret Manager Instance where you want to store GPG Key generated from the steps above.
2. Click on the `Add +` icon on the top right to add new key to the instance.
3. Select `Other secret type` option

| ![Save Key To Secret Manager - Step 1](./images/devsecops_set-up_store_secret_manager_1.png) |
| :--: |

4. Select `Select a key type` as **Standard Key**
5. Give appropriate name in the `Name` field. The stored GPG Key can be retreived later by this name.
6. Choose the option as `Secret value` and Copy the key as exported earlier in the `Secret Value` field.
    > **Note**: Please ensure that while copying the key and pasting it in `Secret value` field, there is no extra line at the end of the key.
7. Add the key to your key protect by clicking `Add` icon at the bottom.

| ![Save Key To Secret Manager - Step 2](./images/devsecops_set-up_store_secret_manager_2.png) |
| :--: |

